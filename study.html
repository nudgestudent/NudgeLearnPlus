<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>学習モード | NudgeLearn+</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Segoe UI",sans-serif;background:#f7fbff;padding:16px;color:#07324a}
.card{max-width:820px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,40,80,0.06)}
input{padding:8px;border-radius:8px;border:1px solid #d6e8ff;width:80%}
button{background:#1a73e8;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;margin:4px}
.btn-ghost{background:#fff;color:#1a73e8;border:1px solid #d6e8ff}
.answer{color:#0b5b2d;font-weight:700}
.wrong{color:#b71c1c;font-weight:700}
.progressBar{height:12px;background:#e6f2ff;border-radius:8px;margin-top:8px}
.bar{height:12px;background:#1a73e8;border-radius:8px;width:0%}
</style>
</head>
<body>
<div class="card">
  <h1 id="title"></h1>
  <div id="questionBox">読み込み中...</div>
  <div style="margin-top:10px">
    <input id="answer" placeholder="答えを入力">
    <button onclick="checkAnswer()">解答</button>
    <button onclick="nextQuestion()" class="btn-ghost">次へ</button>
    <button onclick="finishAndClose()">終了</button>
  </div>
  <div class="progressBar"><div id="bar" class="bar"></div></div>
  <p id="progressText"></p>
</div>

<script>
const p=new URLSearchParams(location.search);
const subject=p.get("subject")||"未選択";
const mode=p.get("mode")||"normal";
document.getElementById("title").textContent=`${subject} の${mode==="review"?"復習":"学習"}モード`;

const Q={
国語:[
  ["『徒然草』の作者は？","吉田兼好"],
  ["『源氏物語』の作者は？","紫式部"],
  ["『枕草子』の冒頭は？","春はあけぼの"],
  ["『平家物語』の冒頭は？","祇園精舎の鐘の声"],
  ["『こころ』の作者は？","夏目漱石"],
  ["『舞姫』の作者は？","森鴎外"],
  ["俳句の季語とは何？","季節を表す言葉"],
  ["五・七・五・七・七の詩形は？","短歌"],
  ["評論文の特徴は？","筆者の意見を論理的に述べる"],
  ["物語文の要素でないものは？","論拠"]
],
数学:[
  ["2x+3=7 のとき x=？","2"],
  ["√2×√8=？","4"],
  ["sin^2θ+cos^2θ=？","1"],
  ["1次関数の一般式は？","y=ax+b"],
  ["二次方程式の解の公式を答えよ","(-b ± √(b² - 4ac)) / 2a"],
  ["πr²は何の式？","円の面積"],
  ["確率1/2を2回出す確率は？","1/4"],
  ["x²のグラフの頂点は？","(0,0)"],
  ["logₐ1=？","0"],
  ["0で割ることは？","できない"]
],
英語:[
  ["'run' の過去形は？","ran"],
  ["'child' の複数形は？","children"],
  ["'I am happy.' を日本語に。","私は幸せです。"],
  ["'go' の過去形は？","went"],
  ["'eat' の過去分詞形は？","eaten"],
  ["'study' の意味は？","勉強する"],
  ["'beautiful' の意味は？","美しい"],
  ["'because' の意味は？","なぜなら"],
  ["'quickly' の品詞は？","副詞"],
  ["'good' の比較級は？","better"]
],
理科:[
  ["水は何度で沸騰する？","100度"],
  ["光合成に必要な気体は？","二酸化炭素"],
  ["血液中で酸素を運ぶ成分は？","ヘモグロビン"],
  ["地震の初期微動を伝える波は？","P波"],
  ["H2Oは何？","水"],
  ["太陽系最大の惑星は？","木星"],
  ["植物が夜に行う呼吸は？","酸素を吸って二酸化炭素を出す"],
  ["電流の単位は？","アンペア"],
  ["力の単位は？","ニュートン"],
  ["金属の特徴は？","電気を通す"]
],
社会:[
  ["日本の首都は？","東京"],
  ["明治維新が起きたのは？","1868年"],
  ["日本国憲法施行年は？","1947年"],
  ["三権分立の三つは？","立法・行政・司法"],
  ["衆議院の任期は？","4年"],
  ["参議院の任期は？","6年"],
  ["EUの正式名称は？","ヨーロッパ連合"],
  ["国連の本部は？","ニューヨーク"],
  ["GDPとは？","国内総生産"],
  ["アメリカ初代大統領は？","ジョージ・ワシントン"]
]
};

// === 復習 or 通常出題 ===
const wrongKey="wrong_"+subject;
let wrongList=JSON.parse(localStorage.getItem(wrongKey)||"[]");
let questions=[];
if(mode==="review"&&wrongList.length>0){questions=wrongList.slice();}else{questions=Q[subject]?Q[subject].slice():[];}

let index=0,solved=0,correct=0;

// === 出題 ===
function render(){
  const box=document.getElementById("questionBox");
  if(!questions.length){box.innerHTML="<p>問題がありません。</p>";return;}
  const [q,a]=questions[index];
  box.innerHTML=`<p><b>Q${index+1}/${questions.length}</b> ${q}</p><p><input id='ans'></p><div id='result'></div>`;
  updateProgress();
}

// === 採点 ===
function checkAnswer(){
  const user=document.getElementById("ans").value.trim();
  const correctAns=questions[index][1];
  const r=document.getElementById("result");
  if(!user){r.innerHTML="<p class='wrong'>答えを入力してください。</p>";return;}
  solved++;
  let ok=normalize(user,correctAns);
  if(ok){correct++;r.innerHTML="<p class='answer'>✅ 正解！</p>";addXP(15);}
  else{r.innerHTML=`<p class='wrong'>❌ 不正解。正解は「${correctAns}」</p>`;addXP(3);markWrong(questions[index]);}
  saveStats(ok);
}

// === 比較 ===
function normalize(a,b){
  if(a===b)return true;
  if(a.toLowerCase()===b.toLowerCase())return true;
  if(!isNaN(a)&&!isNaN(b)&&Number(a)===Number(b))return true;
  return false;
}

// === 間違い記録 ===
function markWrong(item){
  let list=JSON.parse(localStorage.getItem(wrongKey)||"[]");
  if(!list.find(q=>q[0]===item[0]))list.push(item);
  localStorage.setItem(wrongKey,JSON.stringify(list));
}

// === 成績保存 ===
function saveStats(ok){
  const key="stats_"+subject;
  let data=JSON.parse(localStorage.getItem(key)||'{"solved":0,"correct":0}');
  data.solved++;if(ok)data.correct++;
  localStorage.setItem(key,JSON.stringify(data));
  let total=parseInt(localStorage.getItem("totalSolved")||0)+1;
  localStorage.setItem("totalSolved",total);
  updateLeaderboard();
  updateProgress();
}

// === 次へ ===
function nextQuestion(){index=(index+1)%questions.length;render();}

// === 終了 ===
function finishAndClose(){
  const data=JSON.parse(localStorage.getItem("stats_"+subject)||'{"solved":0,"correct":0}');
  const rate=data.solved?Math.round((data.correct/data.solved)*100):0;
  alert(`お疲れさまでした！\n${subject} 正答率 ${rate}%`);
  window.close();
}

// === XP加算 ===
function addXP(n){
  let xp=parseInt(localStorage.getItem("xp")||0)+n;
  localStorage.setItem("xp",xp);
  let level=Math.floor(xp/100)+1;
  localStorage.setItem("level",level);
}

// === リーダーボード更新 ===
function updateLeaderboard(){
  const name=localStorage.getItem("playerName")||"名無し";
  const lb=JSON.parse(localStorage.getItem("leaderboard")||"[]");
  const idx=lb.findIndex(i=>i.name===name);
  const total=parseInt(localStorage.getItem("totalSolved")||0);
  if(idx>=0)lb[idx].score=total;else lb.push({name,score:total});
  lb.sort((a,b)=>b.score-a.score);
  localStorage.setItem("leaderboard",JSON.stringify(lb));
}

// === 進捗 ===
function updateProgress(){
  const data=JSON.parse(localStorage.getItem("stats_"+subject)||'{"solved":0}');
  const total=questions.length;
  const done=Math.min(data.solved,total);
  const per=Math.round((done/total)*100);
  document.getElementById("bar").style.width=per+"%";
  document.getElementById("progressText").textContent=`進捗：${done}/${total} 問 (${per}%)`;
}

render();
</script>
</body>
</html>
